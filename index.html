import React, { useState, useEffect, useMemo } from 'react';
import { 
  Check, Plus, User, Trophy, Calendar, ChevronLeft, ChevronRight, 
  Target, Trash2, LogOut, Activity, Flame, Globe, Settings, Download, Upload, Smartphone, X 
} from 'lucide-react';

// --- –°–ª–æ–≤–∞—Ä–∏ –ø–µ—Ä–µ–≤–æ–¥–æ–≤ ---

const TRANSLATIONS = {
  ru: {
    login_title: "AchieveTracker",
    login_subtitle: "–°–∏—Å—Ç–µ–º–∞—Ç–∏–∑–∏—Ä—É–π—Ç–µ —Ü–µ–ª–∏, –æ—Ç—Å–ª–µ–∂–∏–≤–∞–π—Ç–µ –ø—Ä–∏–≤—ã—á–∫–∏ –∏ –≤–∏–∑—É–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ —Å–≤–æ–π —É—Å–ø–µ—Ö.",
    login_placeholder: "–ö–∞–∫ –≤–∞—Å –∑–æ–≤—É—Ç?",
    login_btn: "–ù–∞—á–∞—Ç—å –ø—É—Ç—å",
    login_select_lang: "–í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫ / –¢–∏–ª–¥–∏ —Ç–∞–Ω–¥–∞“£—ã–∑ / Select Language",
    greeting: "–ü—Ä–∏–≤–µ—Ç",
    greeting_sub: "–î–∞–≤–∞–π –¥–æ—Å—Ç–∏–≥–Ω–µ–º –±–æ–ª—å—à–µ–≥–æ!",
    streak_label: "–°–ï–†–ò–Ø",
    streak_unit: "–¥–Ω–µ–π –ø–æ–¥—Ä—è–¥",
    today_widget: "–°–ï–ì–û–î–ù–Ø",
    tasks_done: "–∑–∞–¥–∞—á –≤—ã–ø–æ–ª–Ω–µ–Ω–æ",
    today_header: "–ó–∞–¥–∞—á–∏ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è",
    my_goals: "–ú–æ–∏ —Ü–µ–ª–∏",
    empty_goals: "–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —Ü–µ–ª–µ–π",
    create_first_goal: "–°–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤—É—é —Ü–µ–ª—å",
    deadline: "–î–µ–¥–ª–∞–π–Ω",
    deadline_year: "–ö–æ–Ω–µ—Ü –≥–æ–¥–∞",
    deadline_month: "–ö–æ–Ω–µ—Ü –º–µ—Å—è—Ü–∞",
    deadline_week: "–ö–æ–Ω–µ—Ü –Ω–µ–¥–µ–ª–∏",
    activity_week: "–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å (–Ω–µ–¥.)",
    open_tracker: "–û—Ç–∫—Ä—ã—Ç—å —Ç—Ä–µ–∫–µ—Ä",
    new_goal: "–ù–æ–≤–∞—è —Ü–µ–ª—å",
    goal_title: "–ù–∞–∑–≤–∞–Ω–∏–µ —Ü–µ–ª–∏",
    goal_title_ph: "–ù–∞–ø—Ä–∏–º–µ—Ä: –í—ã—É—á–∏—Ç—å –∞–Ω–≥–ª–∏–π—Å–∫–∏–π",
    deadline_label: "–°—Ä–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è",
    type_week: "–ù–µ–¥–µ–ª—è",
    type_month: "–ú–µ—Å—è—Ü",
    type_year: "–ì–æ–¥",
    type_date: "–î–∞—Ç–∞",
    desc_label: "–û–ø–∏—Å–∞–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)",
    desc_ph: "–ü–æ—á–µ–º—É —ç—Ç–æ –≤–∞–∂–Ω–æ –¥–ª—è –≤–∞—Å?",
    habits_label: "–ö–ª—é—á–µ–≤—ã–µ –ø—Ä–∏–≤—ã—á–∫–∏ / —à–∞–≥–∏",
    habits_sub: "–ß—Ç–æ –Ω—É–∂–Ω–æ –¥–µ–ª–∞—Ç—å —Ä–µ–≥—É–ª—è—Ä–Ω–æ?",
    add_habit: "+ –î–æ–±–∞–≤–∏—Ç—å",
    habit_ph: "–ù–∞–ø—Ä–∏–º–µ—Ä: –ß–∏—Ç–∞—Ç—å 15 –º–∏–Ω",
    cancel: "–û—Ç–º–µ–Ω–∞",
    days_short: ['–í—Å','–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±'],
    settings_title: "–ù–∞—Å—Ç—Ä–æ–π–∫–∏",
    backup_title: "–†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ",
    backup_desc: "–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ, —á—Ç–æ–±—ã –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ –∏—Ö –Ω–∞ –¥—Ä—É–≥–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ.",
    copy_data: "–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ",
    paste_data: "–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑ –∫–æ–¥–∞",
    data_copied: "–î–∞–Ω–Ω—ã–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã!",
    data_imported: "–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã!",
    install_title: "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω",
    install_ios: "iOS (iPhone): –ù–∞–∂–º–∏—Ç–µ '–ü–æ–¥–µ–ª–∏—Ç—å—Å—è' –≤ Safari ‚Üí '–ù–∞ —ç–∫—Ä–∞–Ω –î–æ–º–æ–π'",
    install_android: "Android: –ù–∞–∂–º–∏—Ç–µ –º–µ–Ω—é (3 —Ç–æ—á–∫–∏) –≤ Chrome ‚Üí '–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ'",
    restore_placeholder: "–í—Å—Ç–∞–≤—å—Ç–µ –∫–æ–¥ –¥–∞–Ω–Ω—ã—Ö —Å—é–¥–∞...",
    restore_btn: "–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å",
    delete_goal: "–£–¥–∞–ª–∏—Ç—å —Ü–µ–ª—å",
    confirm_delete: "–£–¥–∞–ª–∏—Ç—å —ç—Ç—É —Ü–µ–ª—å –∏ –≤–µ—Å—å –ø—Ä–æ–≥—Ä–µ—Å—Å?",
    confirm_logout: "–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏? –î–∞–Ω–Ω—ã–µ –æ—Å—Ç–∞–Ω—É—Ç—Å—è –Ω–∞ —ç—Ç–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ.",
    alert_fill: "–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –ø–æ–¥–∑–∞–¥–∞—á—É (–ø—Ä–∏–≤—ã—á–∫—É)",
    notify_created: "–¶–µ–ª—å —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞! üöÄ",
    notify_great: "–û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞! –¢–∞–∫ –¥–µ—Ä–∂–∞—Ç—å! üéâ",
    goal_type_week: "–ù–µ–¥–µ–ª—å–Ω–∞—è —Ü–µ–ª—å",
    goal_type_long: "–î–æ–ª–≥–æ—Å—Ä–æ—á–Ω–∞—è —Ü–µ–ª—å",
    no_desc: "–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è",
    table_task: "–ó–∞–¥–∞—á–∞"
  },
  ky: {
    login_title: "AchieveTracker",
    login_subtitle: "–ú–∞–∫—Å–∞—Ç—Ç–∞—Ä—ã“£—ã–∑–¥—ã —Å–∏—Å—Ç–µ–º–∞–ª–∞—à—Ç—ã—Ä—ã“£—ã–∑, –∞–¥–∞—Ç—Ç–∞—Ä–¥—ã –∫”©–∑”©–º”©–ª–¥”©“£“Ø–∑ –∂–∞–Ω–∞ –∏–π–≥–∏–ª–∏–≥–∏“£–∏–∑–¥–∏ –∫”©—Ä“Ø“£“Ø–∑.",
    login_placeholder: "–ê—Ç—ã“£—ã–∑ –∫–∏–º?",
    login_btn: "–ë–∞—à—Ç–æ–æ",
    login_select_lang: "–¢–∏–ª–¥–∏ —Ç–∞–Ω–¥–∞“£—ã–∑",
    greeting: "–°–∞–ª–∞–º",
    greeting_sub: "–ö–µ–ª–∏“£–∏–∑, —á–æ“£ –∏–π–≥–∏–ª–∏–∫—Ç–µ—Ä–≥–µ –∂–µ—Ç–µ–ª–∏!",
    streak_label: "–°–ï–†–ò–Ø",
    streak_unit: "–∫“Ø–Ω –∫–∞—Ç–∞—Ä—ã –º–µ–Ω–µ–Ω",
    today_widget: "–ë“Æ–ì“Æ–ù",
    tasks_done: "—Ç–∞–ø—à—ã—Ä–º–∞ –∞—Ç–∫–∞—Ä—ã–ª–¥—ã",
    today_header: "–ë“Ø–≥“Ø–Ω–∫“Ø —Ç–∞–ø—à—ã—Ä–º–∞–ª–∞—Ä",
    my_goals: "–ú–µ–Ω–∏–Ω –º–∞–∫—Å–∞—Ç—Ç–∞—Ä—ã–º",
    empty_goals: "–°–∏–∑–¥–µ –∞–∑—ã—Ä—ã–Ω—á–∞ –º–∞–∫—Å–∞—Ç—Ç–∞—Ä –∂–æ–∫",
    create_first_goal: "–ë–∏—Ä–∏–Ω—á–∏ –º–∞–∫—Å–∞—Ç—Ç—ã —Ç“Ø–∑“Ø“Ø",
    deadline: "–ú”©”©–Ω”©—Ç“Ø",
    deadline_year: "–ñ—ã–ª–¥—ã–Ω –∞—è–≥—ã",
    deadline_month: "–ê–π–¥—ã–Ω –∞—è–≥—ã",
    deadline_week: "–ñ—É–º–∞–Ω—ã–Ω –∞—è–≥—ã",
    activity_week: "–ê–∫—Ç–∏–≤–¥“Ø“Ø–ª“Ø–∫ (–∂—É–º–∞)",
    open_tracker: "–¢—Ä–µ–∫–µ—Ä–¥–∏ –∞—á—É—É",
    new_goal: "–ñ–∞“£—ã –º–∞–∫—Å–∞—Ç",
    goal_title: "–ú–∞–∫—Å–∞—Ç—Ç—ã–Ω –∞—Ç–∞–ª—ã—à—ã",
    goal_title_ph: "–ú–∏—Å–∞–ª—ã: –ê–Ω–≥–ª–∏—Å —Ç–∏–ª–∏–Ω “Ø–π—Ä”©–Ω“Ø“Ø",
    deadline_label: "–ê—Ç–∫–∞—Ä—É—É –º”©”©–Ω”©—Ç“Ø",
    type_week: "–ñ—É–º–∞",
    type_month: "–ê–π",
    type_year: "–ñ—ã–ª",
    type_date: "–î–∞—Ç–∞",
    desc_label: "–°“Ø—Ä”©—Ç—Ç”©–º”© (–º–∏–ª–¥–µ—Ç—Ç“Ø“Ø —ç–º–µ—Å)",
    desc_ph: "–ë—É–ª —Å–∏–∑ “Ø—á“Ø–Ω —ç–º–Ω–µ “Ø—á“Ø–Ω –º–∞–∞–Ω–∏–ª“Ø“Ø?",
    habits_label: "–ù–µ–≥–∏–∑–≥–∏ –∞–¥–∞—Ç—Ç–∞—Ä / –∫–∞–¥–∞–º–¥–∞—Ä",
    habits_sub: "–¢—É—Ä—É–∫—Ç—É—É —ç–º–Ω–µ –∫—ã–ª—É—É –∫–µ—Ä–µ–∫?",
    add_habit: "+ –ö–æ—à—É—É",
    habit_ph: "–ú–∏—Å–∞–ª—ã: 15 –º“Ø–Ω”©—Ç –æ–∫—É—É",
    cancel: "–ñ–æ–∫–∫–æ —á—ã–≥–∞—Ä—É—É",
    days_short: ['–ñ–∫','–î—à','–®—à','–®—Ä','–ë—à','–ñ–º','–ò—à'],
    settings_title: "–ñ”©–Ω–¥”©”©–ª”©—Ä",
    backup_title: "–ú–∞–∞–ª—ã–º–∞—Ç—Ç—ã —Å–∞–∫—Ç–æ–æ",
    backup_desc: "–ë–∞—à–∫–∞ —Ç“Ø–∑–º”©–∫–∫”© ”©—Ç–∫”©—Ä“Ø“Ø “Ø—á“Ø–Ω –º–∞–∞–ª—ã–º–∞—Ç—Ç—ã —Å–∞–∫—Ç–∞“£—ã–∑.",
    copy_data: "–ö”©—á“Ø—Ä“Ø“Ø",
    paste_data: "–ö–∞–ª—ã–±—ã–Ω–∞ –∫–µ–ª—Ç–∏—Ä“Ø“Ø",
    data_copied: "–ú–∞–∞–ª—ã–º–∞—Ç –∫”©—á“Ø—Ä“Ø–ª–¥“Ø!",
    data_imported: "–ú–∞–∞–ª—ã–º–∞—Ç –∏–π–≥–∏–ª–∏–∫—Ç“Ø“Ø –∂–∞“£—ã—Ä—Ç—ã–ª–¥—ã!",
    install_title: "–¢–µ–ª–µ—Ñ–æ–Ω–≥–æ –æ—Ä–Ω–æ—Ç—É—É",
    install_ios: "iOS: Safari'–¥–µ '–ë”©–ª“Ø—à“Ø“Ø' ‚Üí '–ë–∞—à–∫—ã —ç–∫—Ä–∞–Ω–≥–∞ –∫–æ—à—É—É'",
    install_android: "Android: Chrome –º–µ–Ω—é—Å—É ‚Üí '–¢–∏—Ä–∫–µ–º–µ–Ω–∏ –æ—Ä–Ω–æ—Ç—É—É'",
    restore_placeholder: "–ö–æ–¥–¥—É –±—É–ª –∂–µ—Ä–≥–µ –∫–æ—é“£—É–∑...",
    restore_btn: "–ö–∞–ª—ã–±—ã–Ω–∞ –∫–µ–ª—Ç–∏—Ä“Ø“Ø",
    delete_goal: "–ú–∞–∫—Å–∞—Ç—Ç—ã ”©—á“Ø—Ä“Ø“Ø",
    confirm_delete: "–ë—É–ª –º–∞–∫—Å–∞—Ç—Ç—ã –∂–∞–Ω–∞ –±–∞—Ä–¥—ã–∫ –ø—Ä–æ–≥—Ä–µ—Å—Å—Ç–∏ ”©—á“Ø—Ä”©—Å“Ø–∑–±“Ø?",
    confirm_logout: "–ß—ã–≥—É—É–Ω—É –∫–∞–∞–ª–∞–π—Å—ã–∑–±—ã? –ú–∞–∞–ª—ã–º–∞—Ç –±—É–ª —Ç“Ø–∑–º”©–∫—Ç”© —Å–∞–∫—Ç–∞–ª–∞—Ç.",
    alert_fill: "–ê—Ç–∞–ª—ã—à—ã–Ω –∂–∞–Ω–∞ –∂–æ–∫ –¥–µ–≥–µ–Ω–¥–µ –±–∏—Ä —Ç–∞–ø—à—ã—Ä–º–∞–Ω—ã —Ç–æ–ª—Ç—É—Ä—É“£—É–∑",
    notify_created: "–ú–∞–∫—Å–∞—Ç –∏–π–≥–∏–ª–∏–∫—Ç“Ø“Ø —Ç“Ø–∑“Ø–ª–¥“Ø! üöÄ",
    notify_great: "–ê–∑–∞–º–∞—Ç—Å—ã–∑! –£—à—É–Ω—É“£—É–∑–¥—É –∂–∞–∑–±–∞“£—ã–∑! üéâ",
    goal_type_week: "–ñ—É–º–∞–ª—ã–∫ –º–∞–∫—Å–∞—Ç",
    goal_type_long: "–£–∑–∞–∫ –º”©”©–Ω”©—Ç—Ç“Ø“Ø –º–∞–∫—Å–∞—Ç",
    no_desc: "–°“Ø—Ä”©—Ç—Ç”©–º”©—Å“Ø –∂–æ–∫",
    table_task: "–¢–∞–ø—à—ã—Ä–º–∞"
  },
  en: {
    login_title: "AchieveTracker",
    login_subtitle: "Systematize goals, track habits, and visualize your success.",
    login_placeholder: "What is your name?",
    login_btn: "Start Journey",
    login_select_lang: "Select Language",
    greeting: "Hello",
    greeting_sub: "Let's achieve more!",
    streak_label: "STREAK",
    streak_unit: "days in a row",
    today_widget: "TODAY",
    tasks_done: "tasks done",
    today_header: "Tasks for today",
    my_goals: "My Goals",
    empty_goals: "You have no goals yet",
    create_first_goal: "Create first goal",
    deadline: "Deadline",
    deadline_year: "End of year",
    deadline_month: "End of month",
    deadline_week: "End of week",
    activity_week: "Activity (week)",
    open_tracker: "Open tracker",
    new_goal: "New Goal",
    goal_title: "Goal Title",
    goal_title_ph: "E.g.: Learn English",
    deadline_label: "Deadline",
    type_week: "Week",
    type_month: "Month",
    type_year: "Year",
    type_date: "Date",
    desc_label: "Description (optional)",
    desc_ph: "Why is this important to you?",
    habits_label: "Key habits / steps",
    habits_sub: "What to do regularly?",
    add_habit: "+ Add",
    habit_ph: "E.g.: Read 15 min",
    cancel: "Cancel",
    days_short: ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'],
    settings_title: "Settings",
    backup_title: "Backup & Restore",
    backup_desc: "Save your data to transfer to another device.",
    copy_data: "Copy Data",
    paste_data: "Restore from Code",
    data_copied: "Data copied!",
    data_imported: "Data restored successfully!",
    install_title: "Install on Phone",
    install_ios: "iOS: Tap 'Share' in Safari ‚Üí 'Add to Home Screen'",
    install_android: "Android: Tap menu in Chrome ‚Üí 'Install App'",
    restore_placeholder: "Paste data code here...",
    restore_btn: "Restore",
    delete_goal: "Delete Goal",
    confirm_delete: "Delete this goal and all progress?",
    confirm_logout: "Are you sure you want to log out? Data will remain on this device.",
    alert_fill: "Fill in the title and at least one subtask",
    notify_created: "Goal successfully created! üöÄ",
    notify_great: "Great job! Keep it up! üéâ",
    goal_type_week: "Weekly goal",
    goal_type_long: "Long-term goal",
    no_desc: "No description",
    table_task: "Task"
  }
};

const LOCALES = {
  ru: 'ru-RU',
  ky: 'ky-KG', 
  en: 'en-US'
};

// --- –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã UI (–º–∏–Ω–∏-–±–∏–±–ª–∏–æ—Ç–µ–∫–∞) ---

const Card = ({ children, className = "" }) => (
  <div className={`bg-white rounded-2xl shadow-sm border border-slate-100 p-5 ${className}`}>
    {children}
  </div>
);

const Button = ({ children, onClick, variant = "primary", className = "", type = "button", disabled = false }) => {
  const baseStyle = "w-full py-3 rounded-xl font-semibold transition-all duration-200 active:scale-95 flex items-center justify-center gap-2";
  const variants = {
    primary: "bg-indigo-600 text-white hover:bg-indigo-700 shadow-md shadow-indigo-200",
    secondary: "bg-slate-100 text-slate-700 hover:bg-slate-200",
    outline: "border-2 border-slate-200 text-slate-600 hover:border-slate-300",
    danger: "bg-red-50 text-red-600 hover:bg-red-100",
    ghost: "bg-transparent text-slate-500 hover:bg-slate-50"
  };
  return (
    <button 
      type={type} 
      onClick={onClick} 
      disabled={disabled}
      className={`${baseStyle} ${variants[variant]} ${className} ${disabled ? 'opacity-50 cursor-not-allowed' : ''}`}
    >
      {children}
    </button>
  );
};

const Input = ({ label, value, onChange, placeholder, type = "text", required = false }) => (
  <div className="mb-4">
    {label && <label className="block text-sm font-medium text-slate-600 mb-1.5">{label}</label>}
    <input
      type={type}
      value={value}
      onChange={onChange}
      placeholder={placeholder}
      required={required}
      className="w-full px-4 py-3 rounded-xl border border-slate-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none transition-all text-slate-800 placeholder-slate-400"
    />
  </div>
);

const ProgressBar = ({ percentage, colorClass = "bg-indigo-500" }) => (
  <div className="h-2 w-full bg-slate-100 rounded-full overflow-hidden mt-2">
    <div 
      className={`h-full ${colorClass} transition-all duration-500 ease-out`} 
      style={{ width: `${Math.min(100, Math.max(0, percentage))}%` }}
    />
  </div>
);

// --- –£—Ç–∏–ª–∏—Ç—ã ---

const generateId = () => Math.random().toString(36).substr(2, 9);

const getTodayString = () => {
  const d = new Date();
  return d.toISOString().split('T')[0];
};

const formatDate = (dateString, locale) => {
  const options = { day: 'numeric', month: 'long' };
  return new Date(dateString).toLocaleDateString(locale, options);
};

// --- –û—Å–Ω–æ–≤–Ω–æ–µ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ ---

export default function AchieveTracker() {
  // --- –°–æ—Å—Ç–æ—è–Ω–∏–µ ---
  const [user, setUser] = useState(null);
  const [lang, setLang] = useState('ru'); // ru, ky, en
  const [view, setView] = useState('loading'); // loading, login, dashboard, createGoal, goalDetail, settings
  const [goals, setGoals] = useState([]);
  const [activeGoalId, setActiveGoalId] = useState(null);
  const [notification, setNotification] = useState(null);

  // --- –ó–∞–≥—Ä—É–∑–∫–∞/–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö ---
  useEffect(() => {
    const savedUser = localStorage.getItem('achieve_user');
    const savedGoals = JSON.parse(localStorage.getItem('achieve_goals') || '[]');
    const savedLang = localStorage.getItem('achieve_lang');
    
    if (savedLang) setLang(savedLang);

    if (savedUser) {
      setUser(savedUser);
      setGoals(savedGoals);
      setView('dashboard');
    } else {
      setView('login');
    }
  }, []);

  useEffect(() => {
    if (user) localStorage.setItem('achieve_user', user);
    localStorage.setItem('achieve_goals', JSON.stringify(goals));
    localStorage.setItem('achieve_lang', lang);
  }, [user, goals, lang]);

  // --- –õ–æ–≥–∏–∫–∞ ---

  // –•–µ–ª–ø–µ—Ä –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞
  const t = (key) => TRANSLATIONS[lang]?.[key] || key;
  const currentLocale = LOCALES[lang];

  const handleLogin = (name) => {
    setUser(name);
    setView('dashboard');
  };

  const handleLogout = () => {
    if(confirm(t('confirm_logout'))) {
      setUser(null);
      setView('login');
      localStorage.removeItem('achieve_user');
    }
  };

  const handleImportData = (jsonString) => {
    try {
      const parsed = JSON.parse(jsonString);
      if (Array.isArray(parsed)) {
        setGoals(parsed);
        showNotification(t('data_imported'));
        setView('dashboard');
      } else {
        alert("Invalid data format");
      }
    } catch (e) {
      alert("Error parsing data");
    }
  };

  const addGoal = (newGoal) => {
    setGoals([...goals, { ...newGoal, id: generateId(), createdAt: new Date().toISOString(), progress: 0 }]);
    setView('dashboard');
    showNotification(t('notify_created'));
  };

  const deleteGoal = (id) => {
    if (confirm(t('confirm_delete'))) {
      setGoals(goals.filter(g => g.id !== id));
      setView('dashboard');
    }
  };

  const toggleTask = (goalId, taskId, dateString) => {
    setGoals(goals.map(goal => {
      if (goal.id !== goalId) return goal;

      const updatedTasks = goal.tasks.map(task => {
        if (task.id !== taskId) return task;
        
        const logs = { ...task.logs };
        if (logs[dateString]) {
          delete logs[dateString];
        } else {
          logs[dateString] = true;
          if (dateString === getTodayString()) {
            triggerConfetti(); 
          }
        }
        return { ...task, logs };
      });
      return { ...goal, tasks: updatedTasks };
    }));
  };

  const showNotification = (msg) => {
    setNotification(msg);
    setTimeout(() => setNotification(null), 3000);
  };

  const triggerConfetti = () => {
    showNotification(t('notify_great'));
  };

  // --- –í—ã—á–∏—Å–ª—è–µ–º—ã–µ –¥–∞–Ω–Ω—ã–µ ---
  
  const getStreak = () => {
    let streak = 0;
    const today = new Date();
    
    for (let i = 0; i < 365; i++) {
      const d = new Date(today);
      d.setDate(d.getDate() - i);
      const dateStr = d.toISOString().split('T')[0];
      const hasActivity = goals.some(g => g.tasks.some(t => t.logs && t.logs[dateStr]));
      
      if (hasActivity) {
        streak++;
      } else if (i === 0 && !hasActivity) {
        continue; 
      } else {
        break;
      }
    }
    return streak;
  };

  const activeGoal = goals.find(g => g.id === activeGoalId);

  // --- –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –°—Ç—Ä–∞–Ω–∏—Ü ---

  if (view === 'loading') return <div className="min-h-screen flex items-center justify-center bg-slate-50 text-indigo-600">Loading...</div>;

  return (
    <div className="min-h-screen bg-slate-50 font-sans text-slate-800 pb-10">
      <div className="max-w-md mx-auto min-h-screen bg-white sm:shadow-xl sm:my-5 sm:rounded-3xl overflow-hidden relative">
        
        {/* –•–µ–¥–µ—Ä */}
        {view !== 'login' && (
          <header className="px-6 py-5 bg-white border-b border-slate-100 flex justify-between items-center sticky top-0 z-10">
            {view === 'dashboard' ? (
              <div className="flex items-center gap-3">
                <div className="w-10 h-10 bg-indigo-100 rounded-full flex items-center justify-center text-indigo-600 font-bold text-lg">
                  {user[0].toUpperCase()}
                </div>
                <div>
                  <h1 className="font-bold text-lg leading-tight">{t('greeting')}, {user}</h1>
                  <p className="text-xs text-slate-500">{t('greeting_sub')}</p>
                </div>
              </div>
            ) : (
              <button onClick={() => setView('dashboard')} className="p-2 -ml-2 hover:bg-slate-100 rounded-full transition-colors">
                <ChevronLeft className="w-6 h-6 text-slate-600" />
              </button>
            )}
            
            <div className="flex items-center gap-1">
              {view === 'dashboard' && (
                 <button onClick={() => setView('settings')} className="p-2 hover:bg-slate-100 rounded-full text-slate-400">
                   <Settings className="w-5 h-5" />
                 </button>
              )}
            </div>

            {/* –ó–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è –¥—Ä—É–≥–∏—Ö —ç–∫—Ä–∞–Ω–æ–≤ */}
            {view === 'goalDetail' && (
               <h2 className="font-bold text-lg truncate max-w-[200px] absolute left-1/2 -translate-x-1/2">{activeGoal?.title}</h2>
            )}
            {view === 'createGoal' && (
               <h2 className="font-bold text-lg absolute left-1/2 -translate-x-1/2">{t('new_goal')}</h2>
            )}
            {view === 'settings' && (
               <h2 className="font-bold text-lg absolute left-1/2 -translate-x-1/2">{t('settings_title')}</h2>
            )}
          </header>
        )}

        {/* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ */}
        {notification && (
          <div className="absolute top-20 left-4 right-4 bg-indigo-600 text-white py-3 px-4 rounded-xl shadow-lg z-50 animate-bounce-in flex items-center justify-center gap-2">
            <span>{notification}</span>
          </div>
        )}

        {/* –ö–æ–Ω—Ç–µ–Ω—Ç */}
        <main className="p-4">
          
          {view === 'login' && (
            <LoginScreen 
              onLogin={handleLogin} 
              t={t} 
              lang={lang} 
              setLang={setLang} 
            />
          )}
          
          {view === 'dashboard' && (
            <Dashboard 
              user={user} 
              goals={goals} 
              onAdd={() => setView('createGoal')}
              onOpenGoal={(id) => { setActiveGoalId(id); setView('goalDetail'); }}
              streak={getStreak()}
              onToggleTask={toggleTask}
              t={t}
              locale={currentLocale}
            />
          )}

          {view === 'settings' && (
            <SettingsScreen 
              t={t} 
              goals={goals} 
              onImport={handleImportData}
              onLogout={handleLogout}
              lang={lang}
              setLang={setLang}
            />
          )}

          {view === 'createGoal' && (
            <CreateGoalScreen 
              onSave={addGoal} 
              onCancel={() => setView('dashboard')} 
              t={t}
            />
          )}

          {view === 'goalDetail' && activeGoal && (
            <GoalDetailScreen 
              goal={activeGoal} 
              onToggleTask={toggleTask}
              onDelete={() => deleteGoal(activeGoal.id)}
              t={t}
              locale={currentLocale}
            />
          )}

        </main>
      </div>
    </div>
  );
}

// --- –≠–∫—Ä–∞–Ω—ã ---

const LoginScreen = ({ onLogin, t, lang, setLang }) => {
  const [name, setName] = useState('');

  const handleSubmit = (e) => {
    e.preventDefault();
    if (name.trim()) onLogin(name.trim());
  };

  const languages = [
    { code: 'ru', label: '–†—É—Å—Å–∫–∏–π', icon: 'üá∑üá∫' },
    { code: 'ky', label: '–ö—ã—Ä–≥—ã–∑—á–∞', icon: 'üá∞üá¨' },
    { code: 'en', label: 'English', icon: 'üá∫üá∏' },
  ];

  return (
    <div className="flex flex-col items-center justify-center min-h-[80vh] px-6 text-center animate-fade-in">
      <div className="w-20 h-20 bg-indigo-600 rounded-3xl flex items-center justify-center mb-6 shadow-indigo-200 shadow-xl rotate-3">
        <Target className="w-10 h-10 text-white" />
      </div>
      <h1 className="text-3xl font-bold text-slate-800 mb-2">{t('login_title')}</h1>
      <p className="text-slate-500 mb-8 max-w-xs">{t('login_subtitle')}</p>
      
      {/* –í—ã–±–æ—Ä —è–∑—ã–∫–∞ */}
      <div className="flex bg-slate-100 p-1 rounded-xl mb-8 w-full max-w-xs">
        {languages.map((l) => (
          <button
            key={l.code}
            onClick={() => setLang(l.code)}
            className={`flex-1 py-2 text-sm font-medium rounded-lg transition-all ${
              lang === l.code ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'
            }`}
          >
            <span className="mr-1">{l.icon}</span> {l.code.toUpperCase()}
          </button>
        ))}
      </div>
      
      <form onSubmit={handleSubmit} className="w-full max-w-xs space-y-4">
        <Input 
          placeholder={t('login_placeholder')} 
          value={name} 
          onChange={(e) => setName(e.target.value)} 
          required
        />
        <Button type="submit" disabled={!name.trim()}>{t('login_btn')}</Button>
      </form>
    </div>
  );
};

// --- –ù–æ–≤—ã–π –≠–∫—Ä–∞–Ω –ù–∞—Å—Ç—Ä–æ–µ–∫ ---

const SettingsScreen = ({ t, goals, onImport, onLogout, lang, setLang }) => {
  const [importText, setImportText] = useState('');
  const [showImport, setShowImport] = useState(false);

  const copyToClipboard = () => {
    const data = JSON.stringify(goals);
    navigator.clipboard.writeText(data).then(() => {
      alert(t('data_copied'));
    });
  };

  const languages = [
    { code: 'ru', label: '–†—É—Å—Å–∫–∏–π', icon: 'üá∑üá∫' },
    { code: 'ky', label: '–ö—ã—Ä–≥—ã–∑—á–∞', icon: 'üá∞üá¨' },
    { code: 'en', label: 'English', icon: 'üá∫üá∏' },
  ];

  return (
    <div className="space-y-6 animate-fade-in pb-10">
      
      {/* –Ø–∑—ã–∫ */}
      <section className="bg-white rounded-2xl border border-slate-100 p-4 shadow-sm">
        <h3 className="font-bold text-slate-700 mb-3 flex items-center gap-2">
          <Globe className="w-5 h-5 text-indigo-500" /> {t('login_select_lang')}
        </h3>
        <div className="flex bg-slate-50 p-1 rounded-xl">
          {languages.map((l) => (
            <button
              key={l.code}
              onClick={() => setLang(l.code)}
              className={`flex-1 py-2 text-xs sm:text-sm font-medium rounded-lg transition-all ${
                lang === l.code ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'
              }`}
            >
              <span className="mr-1">{l.icon}</span> {l.code.toUpperCase()}
            </button>
          ))}
        </div>
      </section>

      {/* –£—Å—Ç–∞–Ω–æ–≤–∫–∞ */}
      <section className="bg-indigo-50 rounded-2xl border border-indigo-100 p-4">
        <h3 className="font-bold text-indigo-800 mb-2 flex items-center gap-2">
          <Smartphone className="w-5 h-5" /> {t('install_title')}
        </h3>
        <ul className="text-sm text-indigo-700 space-y-2">
          <li className="flex gap-2">
             <span className="font-bold">‚Ä¢</span> {t('install_ios')}
          </li>
          <li className="flex gap-2">
             <span className="font-bold">‚Ä¢</span> {t('install_android')}
          </li>
        </ul>
      </section>

      {/* –ë—ç–∫–∞–ø */}
      <section className="bg-white rounded-2xl border border-slate-100 p-4 shadow-sm">
        <h3 className="font-bold text-slate-700 mb-1 flex items-center gap-2">
          <Download className="w-5 h-5 text-indigo-500" /> {t('backup_title')}
        </h3>
        <p className="text-xs text-slate-500 mb-4">{t('backup_desc')}</p>
        
        <Button onClick={copyToClipboard} variant="outline" className="mb-3">
           {t('copy_data')}
        </Button>
        
        {!showImport ? (
          <Button onClick={() => setShowImport(true)} variant="ghost" className="text-sm">
            {t('paste_data')}
          </Button>
        ) : (
          <div className="mt-2 animate-fade-in">
             <textarea 
               value={importText}
               onChange={e => setImportText(e.target.value)}
               className="w-full border p-2 rounded-xl text-xs font-mono h-24 mb-2"
               placeholder={t('restore_placeholder')}
             />
             <div className="flex gap-2">
               <Button onClick={() => setShowImport(false)} variant="ghost" className="flex-1">{t('cancel')}</Button>
               <Button onClick={() => onImport(importText)} className="flex-1">{t('restore_btn')}</Button>
             </div>
          </div>
        )}
      </section>

      {/* –í—ã—Ö–æ–¥ */}
      <section>
        <Button onClick={onLogout} variant="danger" className="bg-red-50 text-red-500">
           <LogOut className="w-5 h-5" /> –í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞
        </Button>
      </section>
    </div>
  );
};

const Dashboard = ({ goals, onAdd, onOpenGoal, streak, onToggleTask, t, locale }) => {
  const today = getTodayString();
  
  const todaysTasks = useMemo(() => {
    let tasks = [];
    goals.forEach(goal => {
      goal.tasks.forEach(task => {
        tasks.push({ ...task, goalId: goal.id, goalColor: goal.color, goalTitle: goal.title });
      });
    });
    return tasks;
  }, [goals]);

  const completedToday = todaysTasks.filter(t => t.logs && t.logs[today]).length;
  const totalTasks = todaysTasks.length;

  return (
    <div className="space-y-6 pb-20 animate-fade-in">
      
      {/* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */}
      <div className="grid grid-cols-2 gap-3">
        <Card className="p-4 flex flex-col items-center justify-center bg-gradient-to-br from-indigo-500 to-purple-600 text-white border-none">
          <div className="flex items-center gap-1 mb-1 opacity-90">
            <Flame className="w-4 h-4" /> <span className="text-xs font-semibold uppercase">{t('streak_label')}</span>
          </div>
          <span className="text-3xl font-bold">{streak}</span>
          <span className="text-xs opacity-75">{t('streak_unit')}</span>
        </Card>
        <Card className="p-4 flex flex-col items-center justify-center">
           <div className="flex items-center gap-1 mb-1 text-slate-400">
            <Activity className="w-4 h-4" /> <span className="text-xs font-semibold uppercase">{t('today_widget')}</span>
          </div>
          <span className="text-3xl font-bold text-slate-700">{completedToday}<span className="text-lg text-slate-400">/{totalTasks}</span></span>
          <span className="text-xs text-slate-400">{t('tasks_done')}</span>
        </Card>
      </div>

      {/* –í–∏–¥–∂–µ—Ç "–°–µ–≥–æ–¥–Ω—è" */}
      {totalTasks > 0 && (
        <section>
          <div className="flex items-center justify-between mb-3 px-1">
            <h3 className="font-bold text-slate-700 text-lg">{t('today_header')}</h3>
            <span className="text-xs bg-indigo-100 text-indigo-700 px-2 py-1 rounded-full font-medium">{formatDate(today, locale)}</span>
          </div>
          <div className="space-y-2">
            {todaysTasks.map(task => {
              const isDone = !!(task.logs && task.logs[today]);
              return (
                <div key={`${task.goalId}-${task.id}`} 
                     onClick={() => onToggleTask(task.goalId, task.id, today)}
                     className={`p-3 rounded-xl border flex items-center gap-3 transition-all cursor-pointer active:scale-[0.98] ${isDone ? 'bg-indigo-50 border-indigo-200' : 'bg-white border-slate-100'}`}
                >
                  <div className={`w-6 h-6 rounded-lg flex items-center justify-center border-2 transition-colors ${isDone ? 'bg-indigo-500 border-indigo-500' : 'border-slate-300'}`}>
                    {isDone && <Check className="w-4 h-4 text-white" />}
                  </div>
                  <div className="flex-1">
                    <p className={`text-sm font-medium ${isDone ? 'text-slate-500 line-through' : 'text-slate-800'}`}>{task.title}</p>
                    <p className="text-[10px] text-slate-400 uppercase tracking-wider">{task.goalTitle}</p>
                  </div>
                </div>
              );
            })}
          </div>
        </section>
      )}

      {/* –°–ø–∏—Å–æ–∫ –¶–µ–ª–µ–π */}
      <section>
        <div className="flex items-center justify-between mb-3 px-1">
          <h3 className="font-bold text-slate-700 text-lg">{t('my_goals')}</h3>
        </div>
        
        {goals.length === 0 ? (
          <div className="text-center py-10 bg-white rounded-2xl border border-dashed border-slate-300">
            <div className="w-12 h-12 bg-slate-50 rounded-full flex items-center justify-center mx-auto mb-3">
              <Plus className="w-6 h-6 text-slate-400" />
            </div>
            <p className="text-slate-500 mb-4">{t('empty_goals')}</p>
            <Button variant="ghost" onClick={onAdd} className="text-indigo-600">{t('create_first_goal')}</Button>
          </div>
        ) : (
          <div className="space-y-4">
            {goals.map(goal => {
               let filledCount = 0;
               let totalChecks = 0;
               const lookback = 7;
               
               goal.tasks.forEach(t => {
                 for(let i=0; i<lookback; i++) {
                   const d = new Date(); d.setDate(d.getDate() - i);
                   const s = d.toISOString().split('T')[0];
                   totalChecks++;
                   if(t.logs && t.logs[s]) filledCount++;
                 }
               });
               
               const percent = totalChecks === 0 ? 0 : Math.round((filledCount / totalChecks) * 100);

               const deadlineText = 
                goal.deadlineType === 'date' ? formatDate(goal.deadlineValue, locale) : 
                goal.deadlineType === 'year' ? t('deadline_year') : 
                goal.deadlineType === 'month' ? t('deadline_month') : t('deadline_week');

               return (
                <Card key={goal.id} className="relative overflow-hidden group">
                  <div className="flex justify-between items-start mb-2">
                    <div>
                      <h4 className="font-bold text-lg text-slate-800">{goal.title}</h4>
                      <p className="text-xs text-slate-500 flex items-center gap-1 mt-1">
                        <Calendar className="w-3 h-3" /> {t('deadline')}: {deadlineText}
                      </p>
                    </div>
                    <div className={`w-10 h-10 rounded-full flex items-center justify-center bg-${goal.color}-100 text-${goal.color}-600`}>
                       <Trophy className={`w-5 h-5 text-indigo-500`} />
                    </div>
                  </div>
                  
                  <div className="mb-4">
                    <div className="flex justify-between text-xs text-slate-500 mb-1">
                      <span>{t('activity_week')}</span>
                      <span>{percent}%</span>
                    </div>
                    <ProgressBar percentage={percent} />
                  </div>

                  <Button variant="secondary" onClick={() => onOpenGoal(goal.id)} className="w-full text-sm py-2">
                    {t('open_tracker')}
                  </Button>
                </Card>
              );
            })}
          </div>
        )}
      </section>

      {/* FAB */}
      <button 
        onClick={onAdd}
        className="fixed bottom-6 right-6 w-14 h-14 bg-indigo-600 text-white rounded-full shadow-lg shadow-indigo-300 flex items-center justify-center hover:scale-110 transition-transform z-20"
      >
        <Plus className="w-7 h-7" />
      </button>
    </div>
  );
};

const CreateGoalScreen = ({ onSave, onCancel, t }) => {
  const [title, setTitle] = useState('');
  const [deadlineType, setDeadlineType] = useState('month');
  const [deadlineValue, setDeadlineValue] = useState('');
  const [description, setDescription] = useState('');
  const [tasks, setTasks] = useState([{ id: generateId(), title: '', logs: {} }]);

  const handleTaskChange = (id, val) => {
    setTasks(tasks.map(t => t.id === id ? { ...t, title: val } : t));
  };

  const addTaskField = () => {
    setTasks([...tasks, { id: generateId(), title: '', logs: {} }]);
  };

  const removeTaskField = (id) => {
    if (tasks.length > 1) {
      setTasks(tasks.filter(t => t.id !== id));
    }
  };

  const handleSubmit = (e) => {
    e.preventDefault();
    const validTasks = tasks.filter(t => t.title.trim() !== '');
    if (!title.trim() || validTasks.length === 0) {
      alert(t('alert_fill'));
      return;
    }

    onSave({
      title,
      deadlineType,
      deadlineValue,
      description,
      tasks: validTasks,
      color: 'indigo'
    });
  };

  return (
    <div className="pb-10 animate-fade-in">
      <form onSubmit={handleSubmit} className="space-y-6">
        
        <section>
          <label className="block text-sm font-bold text-slate-700 mb-2">{t('goal_title')}</label>
          <input 
            className="w-full text-2xl font-bold border-b-2 border-slate-200 focus:border-indigo-500 outline-none py-2 bg-transparent placeholder-slate-300 text-slate-800"
            placeholder={t('goal_title_ph')}
            value={title}
            onChange={e => setTitle(e.target.value)}
            autoFocus
          />
        </section>

        <section>
          <label className="block text-sm font-bold text-slate-700 mb-3">{t('deadline_label')}</label>
          <div className="grid grid-cols-4 gap-2 mb-3">
            {['week', 'month', 'year', 'date'].map(type => (
              <button
                key={type}
                type="button"
                onClick={() => setDeadlineType(type)}
                className={`text-xs py-2 rounded-lg font-medium transition-colors ${deadlineType === type ? 'bg-indigo-600 text-white shadow-md' : 'bg-white border border-slate-200 text-slate-600'}`}
              >
                {t(`type_${type}`)}
              </button>
            ))}
          </div>
          {deadlineType === 'date' && (
            <Input type="date" value={deadlineValue} onChange={e => setDeadlineValue(e.target.value)} />
          )}
        </section>

        <section>
           <label className="block text-sm font-bold text-slate-700 mb-2">{t('desc_label')}</label>
           <textarea 
             className="w-full px-4 py-3 rounded-xl border border-slate-200 focus:border-indigo-500 outline-none resize-none text-slate-700 h-24"
             placeholder={t('desc_ph')}
             value={description}
             onChange={e => setDescription(e.target.value)}
           />
        </section>

        <section>
          <div className="flex justify-between items-center mb-3">
            <label className="block text-sm font-bold text-slate-700">{t('habits_label')}</label>
            <button type="button" onClick={addTaskField} className="text-xs text-indigo-600 font-bold bg-indigo-50 px-2 py-1 rounded-md">{t('add_habit')}</button>
          </div>
          <p className="text-xs text-slate-400 mb-3">{t('habits_sub')}</p>
          
          <div className="space-y-3">
            {tasks.map((task, idx) => (
              <div key={task.id} className="flex gap-2 items-center">
                 <span className="text-slate-400 text-xs font-mono w-4">{idx + 1}.</span>
                 <input 
                   className="flex-1 px-3 py-2 rounded-lg border border-slate-200 focus:border-indigo-500 outline-none text-sm"
                   placeholder={t('habit_ph')}
                   value={task.title}
                   onChange={e => handleTaskChange(task.id, e.target.value)}
                 />
                 {tasks.length > 1 && (
                   <button type="button" onClick={() => removeTaskField(task.id)} className="text-slate-300 hover:text-red-500">
                     <Trash2 className="w-4 h-4" />
                   </button>
                 )}
              </div>
            ))}
          </div>
        </section>

        <div className="pt-4 flex gap-3">
          <Button variant="secondary" onClick={onCancel}>{t('cancel')}</Button>
          <Button type="submit">{t('create_goal_btn')}</Button>
        </div>

      </form>
    </div>
  );
};

const GoalDetailScreen = ({ goal, onToggleTask, onDelete, t, locale }) => {
  const [viewOffset, setViewOffset] = useState(0); 
  const daysToShow = 7; 
  
  const days = useMemo(() => {
    const arr = [];
    const today = new Date();
    const dayOfWeek = today.getDay() || 7; 
    const startOfWeek = new Date(today);
    startOfWeek.setDate(today.getDate() - dayOfWeek + 1 + (viewOffset * 7));

    for (let i = 0; i < daysToShow; i++) {
      const d = new Date(startOfWeek);
      d.setDate(startOfWeek.getDate() + i);
      arr.push(d);
    }
    return arr;
  }, [viewOffset, daysToShow]);

  const currentMonthName = days[0].toLocaleString(locale, { month: 'long', year: 'numeric' });
  const dayNames = t('days_short');

  return (
    <div className="pb-10 animate-fade-in">
      
      {/* –®–∞–ø–∫–∞ —Ü–µ–ª–∏ */}
      <div className="mb-6">
        <div className="flex items-center gap-2 mb-2">
          <span className="bg-indigo-100 text-indigo-700 px-2 py-1 rounded text-xs font-bold uppercase tracking-wide">
             {goal.deadlineType === 'week' ? t('goal_type_week') : t('goal_type_long')}
          </span>
        </div>
        <p className="text-slate-600 text-sm">{goal.description || t('no_desc')}</p>
      </div>

      {/* –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –¥–∞—Ç–∞–º */}
      <div className="flex items-center justify-between mb-4 bg-white p-2 rounded-xl border border-slate-100 shadow-sm">
        <button onClick={() => setViewOffset(p => p - 1)} className="p-2 hover:bg-slate-50 rounded-lg text-slate-500">
          <ChevronLeft className="w-5 h-5" />
        </button>
        <span className="font-bold text-slate-700 capitalize">{currentMonthName}</span>
        <button onClick={() => setViewOffset(p => p + 1)} className="p-2 hover:bg-slate-50 rounded-lg text-slate-500">
          <ChevronRight className="w-5 h-5" />
        </button>
      </div>

      {/* –¢—Ä–µ–∫–µ—Ä (–ú–∞—Ç—Ä–∏—Ü–∞) */}
      <div className="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
        
        {/* –®–∞–ø–∫–∞ —Ç–∞–±–ª–∏—Ü—ã (–î–Ω–∏ –Ω–µ–¥–µ–ª–∏) */}
        <div className="grid grid-cols-[3fr_repeat(7,1fr)] bg-slate-50 border-b border-slate-100">
           <div className="p-3 text-xs font-bold text-slate-400 uppercase tracking-wider flex items-end">{t('table_task')}</div>
           {days.map((d, i) => {
             const isToday = d.toISOString().split('T')[0] === getTodayString();
             return (
               <div key={i} className={`p-2 text-center flex flex-col items-center justify-center ${isToday ? 'bg-indigo-50' : ''}`}>
                 <span className={`text-[10px] font-bold ${isToday ? 'text-indigo-600' : 'text-slate-400'}`}>
                   {dayNames[d.getDay()]}
                 </span>
                 <span className={`text-xs font-bold mt-1 w-6 h-6 flex items-center justify-center rounded-full ${isToday ? 'bg-indigo-600 text-white' : 'text-slate-700'}`}>
                   {d.getDate()}
                 </span>
               </div>
             )
           })}
        </div>

        {/* –¢–µ–ª–æ —Ç–∞–±–ª–∏—Ü—ã (–ó–∞–¥–∞—á–∏) */}
        <div className="divide-y divide-slate-100">
          {goal.tasks.map(task => (
            <div key={task.id} className="grid grid-cols-[3fr_repeat(7,1fr)]">
              <div className="p-3 flex items-center">
                <span className="text-xs sm:text-sm font-medium text-slate-700 leading-tight">{task.title}</span>
              </div>
              {days.map((d, i) => {
                const dateStr = d.toISOString().split('T')[0];
                const isDone = !!(task.logs && task.logs[dateStr]);
                const isFuture = d > new Date();

                return (
                  <div key={i} className={`border-l border-slate-50 flex items-center justify-center relative`}>
                     <button
                       disabled={isFuture}
                       onClick={() => onToggleTask(goal.id, task.id, dateStr)}
                       className={`w-8 h-8 rounded-lg flex items-center justify-center transition-all duration-300
                         ${isFuture ? 'opacity-20 cursor-default' : 'hover:bg-slate-100 active:scale-90 cursor-pointer'}
                         ${isDone ? 'bg-green-500 shadow-md shadow-green-200' : 'bg-slate-100'}
                       `}
                     >
                       {isDone && <Check className="w-5 h-5 text-white animate-scale-in" />}
                     </button>
                  </div>
                );
              })}
            </div>
          ))}
        </div>
      </div>

      <div className="mt-8">
        <Button variant="danger" onClick={onDelete} className="bg-white border border-red-100 text-red-500 hover:bg-red-50">
           <Trash2 className="w-4 h-4" /> {t('delete_goal')}
        </Button>
      </div>

    </div>
  );
};

// CSS —Å—Ç–∏–ª–∏ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–π (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏)
